<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Deepak Kumar Singh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <!-- Login Form -->
    <div id="loginContainer" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <i class="fas fa-shield-alt text-4xl text-white mb-4"></i>
                <h1 class="text-2xl font-bold text-white mb-2">Admin Dashboard</h1>
                <p class="text-gray-300">Secure access to portfolio management</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-white text-sm font-medium mb-2">
                        <i class="fas fa-user mr-2"></i>Username
                    </label>
                    <input type="text" id="username" required
                           class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Enter username">
                </div>
                
                <div>
                    <label class="block text-white text-sm font-medium mb-2">
                        <i class="fas fa-lock mr-2"></i>Password
                    </label>
                    <div class="relative">
                        <input type="password" id="password" required
                               class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-12"
                               placeholder="Enter password">
                        <button type="button" id="togglePassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-300 hover:text-white">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div id="twoFactorContainer" class="hidden">
                    <label class="block text-white text-sm font-medium mb-2">
                        <i class="fas fa-mobile-alt mr-2"></i>2FA Code
                    </label>
                    <input type="text" id="twoFactorCode" maxlength="6"
                           class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-lg tracking-widest"
                           placeholder="000000">
                </div>
                
                <button type="submit" id="loginBtn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                    <span id="loginBtnText">Sign In</span>
                    <div id="loginSpinner" class="loading-spinner hidden ml-2"></div>
                </button>
                
                <div id="errorMessage" class="hidden bg-red-500/20 border border-red-500/40 rounded-lg p-3 text-red-200 text-sm"></div>
                
                <div class="text-center text-gray-300 text-sm">
                    <p>Default credentials: admin / admin123!@#</p>
                    <p class="text-xs mt-2">Secure access with rate limiting & 2FA</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="dashboardContainer" class="hidden">
        <!-- Header -->
        <header class="glass-effect border-b border-white/20 p-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-shield-alt text-2xl text-white"></i>
                    <h1 class="text-xl font-bold text-white">Admin Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userInfo" class="text-white"></span>
                    <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition duration-200">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto p-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="glass-effect rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Total Submissions</p>
                            <p id="totalSubmissions" class="text-2xl font-bold text-white">-</p>
                        </div>
                        <i class="fas fa-envelope text-3xl text-blue-400"></i>
                    </div>
                </div>
                
                <div class="glass-effect rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Unique Emails</p>
                            <p id="uniqueEmails" class="text-2xl font-bold text-white">-</p>
                        </div>
                        <i class="fas fa-users text-3xl text-green-400"></i>
                    </div>
                </div>
                
                <div class="glass-effect rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Recent (7 days)</p>
                            <p id="recentSubmissions" class="text-2xl font-bold text-white">-</p>
                        </div>
                        <i class="fas fa-clock text-3xl text-yellow-400"></i>
                    </div>
                </div>
                
                <div class="glass-effect rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-300 text-sm">Avg/Day</p>
                            <p id="avgPerDay" class="text-2xl font-bold text-white">-</p>
                        </div>
                        <i class="fas fa-chart-line text-3xl text-purple-400"></i>
                    </div>
                </div>
            </div>

            <!-- Recent Submissions -->
            <div class="glass-effect rounded-xl p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white">Recent Submissions</h2>
                    <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
                
                <div id="submissionsTable" class="overflow-x-auto">
                    <table class="w-full text-white">
                        <thead>
                            <tr class="border-b border-white/20">
                                <th class="text-left py-3 px-4">Name</th>
                                <th class="text-left py-3 px-4">Email</th>
                                <th class="text-left py-3 px-4">Subject</th>
                                <th class="text-left py-3 px-4">Date</th>
                                <th class="text-left py-3 px-4">IP Address</th>
                                <th class="text-left py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="submissionsBody">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-gray-400">
                                    <div class="loading-spinner mx-auto mb-4"></div>
                                    Loading submissions...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Security Settings -->
            <div class="glass-effect rounded-xl p-6">
                <h2 class="text-xl font-bold text-white mb-6">Security Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-4">Password Management</h3>
                        <form id="changePasswordForm" class="space-y-4">
                            <div>
                                <label class="block text-gray-300 text-sm mb-2">Current Password</label>
                                <input type="password" id="currentPassword" required
                                       class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-gray-300 text-sm mb-2">New Password</label>
                                <input type="password" id="newPassword" required minlength="8"
                                       class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200">
                                Change Password
                            </button>
                        </form>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-4">Two-Factor Authentication</h3>
                        <div id="twoFactorStatus" class="mb-4">
                            <p class="text-gray-300">Status: <span id="twoFactorStatusText">Checking...</span></p>
                        </div>
                        <button id="setup2FABtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            Setup 2FA
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 2FA Setup Modal -->
    <div id="twoFactorModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="glass-effect rounded-2xl p-8 w-full max-w-md">
            <h3 class="text-xl font-bold text-white mb-4">Setup Two-Factor Authentication</h3>
            <p class="text-gray-300 mb-6">Scan this QR code with your authenticator app:</p>
            <div class="text-center mb-6">
                <canvas id="qrCode" class="mx-auto bg-white p-4 rounded-lg"></canvas>
            </div>
            <div class="mb-6">
                <label class="block text-white text-sm mb-2">Enter verification code:</label>
                <input type="text" id="verify2FACode" maxlength="6"
                       class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-lg tracking-widest">
            </div>
            <div class="flex space-x-4">
                <button id="enable2FABtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200">
                    Enable 2FA
                </button>
                <button id="cancel2FABtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition duration-200">
                    Cancel
                </button>
            </div>
            <div class="mt-4 p-3 bg-yellow-500/20 border border-yellow-500/40 rounded-lg">
                <p class="text-yellow-200 text-sm">
                    <strong>Backup Codes:</strong>
                </p>
                <div id="backupCodes" class="text-yellow-100 text-xs font-mono mt-2"></div>
                <p class="text-yellow-200 text-xs mt-2">Save these codes in a secure location!</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://portfolio-backend-524462978803.us-central1.run.app';
        let accessToken = localStorage.getItem('admin_access_token');
        let refreshToken = localStorage.getItem('admin_refresh_token');
        let currentUser = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            if (accessToken) {
                verifyTokenAndLoadDashboard();
            } else {
                showLogin();
            }
            
            setupEventListeners();
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('togglePassword').addEventListener('click', togglePassword);
            
            // Dashboard
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('refreshBtn').addEventListener('click', loadDashboardData);
            document.getElementById('changePasswordForm').addEventListener('submit', handlePasswordChange);
            document.getElementById('setup2FABtn').addEventListener('click', setup2FA);
            
            // 2FA Modal
            document.getElementById('enable2FABtn').addEventListener('click', enable2FA);
            document.getElementById('cancel2FABtn').addEventListener('click', close2FAModal);
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const twoFactorCode = document.getElementById('twoFactorCode').value;
            
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginSpinner = document.getElementById('loginSpinner');
            const errorMessage = document.getElementById('errorMessage');
            
            // Show loading
            loginBtn.disabled = true;
            loginBtnText.textContent = 'Signing In...';
            loginSpinner.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username,
                        password,
                        two_factor_code: twoFactorCode || null
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Store tokens
                    accessToken = data.access_token;
                    refreshToken = data.refresh_token;
                    currentUser = data.user;
                    
                    localStorage.setItem('admin_access_token', accessToken);
                    localStorage.setItem('admin_refresh_token', refreshToken);
                    localStorage.setItem('admin_user', JSON.stringify(currentUser));
                    
                    showDashboard();
                } else {
                    throw new Error(data.detail || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorMessage.textContent = error.message;
                errorMessage.classList.remove('hidden');
                document.getElementById('loginForm').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('loginForm').classList.remove('shake');
                }, 500);
            } finally {
                loginBtn.disabled = false;
                loginBtnText.textContent = 'Sign In';
                loginSpinner.classList.add('hidden');
            }
        }

        async function verifyTokenAndLoadDashboard() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    currentUser = JSON.parse(localStorage.getItem('admin_user'));
                    showDashboard();
                } else {
                    // Try to refresh token
                    await refreshAccessToken();
                }
            } catch (error) {
                console.error('Token verification failed:', error);
                showLogin();
            }
        }

        async function refreshAccessToken() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/auth/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        refresh_token: refreshToken
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.access_token;
                    localStorage.setItem('admin_access_token', accessToken);
                    currentUser = JSON.parse(localStorage.getItem('admin_user'));
                    showDashboard();
                } else {
                    throw new Error('Token refresh failed');
                }
            } catch (error) {
                console.error('Token refresh failed:', error);
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('dashboardContainer').classList.add('hidden');
            localStorage.removeItem('admin_access_token');
            localStorage.removeItem('admin_refresh_token');
            localStorage.removeItem('admin_user');
            accessToken = null;
            refreshToken = null;
            currentUser = null;
        }

        function showDashboard() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('dashboardContainer').classList.remove('hidden');
            
            if (currentUser) {
                document.getElementById('userInfo').textContent = `Welcome, ${currentUser.username}`;
            }
            
            loadDashboardData();
        }

        async function loadDashboardData() {
            await Promise.all([
                loadStatistics(),
                loadRecentSubmissions()
            ]);
        }

        async function loadStatistics() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/statistics`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalSubmissions').textContent = data.statistics.total_submissions;
                    document.getElementById('uniqueEmails').textContent = data.statistics.unique_emails;
                    document.getElementById('recentSubmissions').textContent = data.statistics.recent_submissions;
                    document.getElementById('avgPerDay').textContent = data.statistics.average_per_day.toFixed(1);
                }
            } catch (error) {
                console.error('Failed to load statistics:', error);
            }
        }

        async function loadRecentSubmissions() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/submissions/recent?limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                const tbody = document.getElementById('submissionsBody');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.submissions && data.submissions.length > 0) {
                        tbody.innerHTML = data.submissions.map(submission => `
                            <tr class="border-b border-white/10">
                                <td class="py-3 px-4">${submission.name}</td>
                                <td class="py-3 px-4">${submission.email}</td>
                                <td class="py-3 px-4">${submission.subject}</td>
                                <td class="py-3 px-4">${new Date(submission.timestamp).toLocaleDateString()}</td>
                                <td class="py-3 px-4">${submission.ip_address}</td>
                                <td class="py-3 px-4">
                                    <button onclick="viewSubmission('${submission.submission_id}')" 
                                            class="text-blue-400 hover:text-blue-300 mr-2">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="deleteSubmission('${submission.submission_id}')" 
                                            class="text-red-400 hover:text-red-300">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">No submissions found</td></tr>';
                    }
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-400">Failed to load submissions</td></tr>';
                }
            } catch (error) {
                console.error('Failed to load submissions:', error);
                document.getElementById('submissionsBody').innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-400">Error loading submissions</td></tr>';
            }
        }

        async function handlePasswordChange(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/auth/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                if (response.ok) {
                    alert('Password changed successfully!');
                    document.getElementById('changePasswordForm').reset();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to change password');
                }
            } catch (error) {
                console.error('Password change error:', error);
                alert('Failed to change password');
            }
        }

        async function setup2FA() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/auth/setup-2fa`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Generate QR code
                    const canvas = document.getElementById('qrCode');
                    QRCode.toCanvas(canvas, data.qr_code_url, function (error) {
                        if (error) console.error('QR code generation failed:', error);
                    });
                    
                    // Show backup codes
                    const backupCodesDiv = document.getElementById('backupCodes');
                    backupCodesDiv.innerHTML = data.backup_codes.map(code => 
                        `<span class="inline-block bg-yellow-600/30 px-2 py-1 rounded mr-1 mb-1">${code}</span>`
                    ).join('');
                    
                    document.getElementById('twoFactorModal').classList.remove('hidden');
                } else {
                    alert('Failed to setup 2FA');
                }
            } catch (error) {
                console.error('2FA setup error:', error);
                alert('Failed to setup 2FA');
            }
        }

        async function enable2FA() {
            const code = document.getElementById('verify2FACode').value;
            
            if (!code || code.length !== 6) {
                alert('Please enter a valid 6-digit code');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/auth/enable-2fa`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        code: code
                    })
                });
                
                if (response.ok) {
                    alert('2FA enabled successfully!');
                    close2FAModal();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to enable 2FA');
                }
            } catch (error) {
                console.error('2FA enable error:', error);
                alert('Failed to enable 2FA');
            }
        }

        function close2FAModal() {
            document.getElementById('twoFactorModal').classList.add('hidden');
            document.getElementById('verify2FACode').value = '';
        }

        async function handleLogout() {
            try {
                await fetch(`${API_BASE_URL}/api/admin/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                showLogin();
            }
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleBtn = document.getElementById('togglePassword');
            const icon = toggleBtn.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Global functions for submission actions
        async function viewSubmission(submissionId) {
            // Implementation for viewing submission details
            alert(`View submission: ${submissionId}`);
        }

        async function deleteSubmission(submissionId) {
            if (!confirm('Are you sure you want to delete this submission?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/submissions/${submissionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    loadRecentSubmissions();
                    loadStatistics();
                } else {
                    alert('Failed to delete submission');
                }
            } catch (error) {
                console.error('Delete submission error:', error);
                alert('Failed to delete submission');
            }
        }
    </script>
</body>
</html>
